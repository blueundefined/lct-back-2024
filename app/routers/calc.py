from typing import List

def calculate_k2(PA1: float, PA2: float, KSZU1: float, KSZU2: float) -> float:
    return (PA1 * 100 / PA2 * 100) * (KSZU2 / KSZU1)

def calculate_lease_rate(n: int, S: List[float], P: List[float], KSZU: float, k: float, k1: float, k2: float) -> float:
    total = 0
    for i in range(n):
        total += P[i] * S[i]
    rate = (total / (KSZU * 1.001)) * k * k1 * k2 * 100
    return rate

from fastapi import APIRouter, FastAPI, HTTPException
from pydantic import BaseModel, Field
from app.config import config
from typing import List

router = APIRouter(prefix=config.BACKEND_PREFIX)

"""
n - количество видов функционального назначения помещений в объекте(ах) капитального строительства в соответствии с градостроительным планом земельного участка;
Si - общая площадь объекта капитального строительства, в том числе помещений, измеряемая в габаритах наружных стен по внешнему обмеру, i-го вида функционального назначения в объекте(ах) капитального строительства (кв. м);
i - вид функционального назначения объекта(ов) капитального строительства и (или) помещения i-го вида функционального назначения в объекте(ах) капитального строительства в соответствии с градостроительным планом земельного участка;
Pi - базовый стоимостной показатель помещения i-го вида функционального назначения в объекте(ах) капитального строительства (рублей за один квадратный метр помещения i-го вида функционального назначения). Определяется в соответствии с таблицей 1 настоящего приложения. При отсутствии в кадастровом квартале стоимостного показателя объекта капитального строительства, расположенного за пределами территории города Москвы, применяется базовый стоимостной показатель, равный 115502,39 рублей за кв. м для жилой застройки и 71051,37 рублей за кв. м для гостиниц и объектов временного проживания;
КСЗУ - кадастровая стоимость земельного участка (руб.);
k - коэффициент ренты. Определяется в соответствии с таблицей 2 настоящего приложения. Для земельных участков, расположенных за пределами территории города Москвы, применяется коэффициент ренты, равный 0,1000. При этом для целей, указанных в пунктах 3.5(1).1 и 3.7.1.1 настоящего постановления, размер коэффициента ренты уменьшается на 15 процентов;
(в ред. постановления Правительства Москвы от 07.06.2022 N 996-ПП)
k1 - коэффициент изменения цен, установленный на дату обращения. Устанавливается правовым актом Департамента городского имущества города Москвы на основании официальной ежеквартальной статистической информации Федеральной службы государственной статистики об уровне цен на рынке жилья в городе Москве, размещенной на официальном сайте Федеральной службы государственной статистики в информационно-телекоммуникационной сети Интернет;
k2 - коэффициент доходности земельного участка равняется 1.
(в ред. постановления Правительства Москвы от 07.06.2022 N 996-ПП)

В случае если кадастровая стоимость земельного участка установлена в размере его рыночной стоимости, коэффициент доходности не может быть меньше 1 и определяется по формуле:
(в ред. постановления Правительства Москвы от 07.06.2022 N 996-ПП)


РА1 - рентабельность проданных товаров, продукции, работ, услуг по городу Москве для вида экономической деятельности "Строительство жилых и нежилых зданий" в первом квартале года, в котором кадастровая стоимость земельного участка установлена в размере его рыночной стоимости (%). Ежеквартально размещается на официальном сайте Федеральной службы государственной статистики в информационно-телекоммуникационной сети Интернет;
РА2 - рентабельность проданных товаров, продукции, работ, услуг по городу Москве для вида экономической деятельности "Строительство жилых и нежилых зданий" в первом квартале года, предшествующего году, в котором кадастровая стоимость земельного участка установлена в размере его рыночной стоимости (%). Ежеквартально размещается на официальном сайте Федеральной службы государственной статистики в информационно-телекоммуникационной сети Интернет;
КСЗУ1 - кадастровая стоимость земельного участка, установленная в размере его рыночной стоимости в рублях;
КСЗУ2 - кадастровая стоимость земельного участка, установленная в порядке, определенном статьей 14 или статьей 16 Федерального закона от 3 июля 2016 г. N 237-ФЗ "О государственной кадастровой оценке", в рублях.

"""

class LeaseRateRequest(BaseModel):
    n: int = Field(..., description="Количество видов функц. назначения")
    S: List[float] = Field(..., description="Площади помещений")
    P: List[float] = Field(..., description="Базовые стоимостные показатели")
    KSZU: float = Field(..., description="Кадастровая стоимость земельного участка")
    k: float = Field(..., description="Коэффициент ренты")
    k1: float = Field(..., description="Коэффициент изменения цен")
    k2_params: dict = Field(..., description="Параметры для расчета коэффициента доходности")

class K2Params(BaseModel):
    PA1: float = Field(..., description="Рентабельность проданных товаров, продукции, работ, услуг по городу Москве для вида экономической деятельности 'Строительство жилых и нежилых зданий' в первом квартале года, в котором кадастровая стоимость земельного участка установлена в размере его рыночной стоимости (%)")
    PA2: float = Field(..., description="Рентабельность проданных товаров, продукции, работ, услуг по городу Москве для вида экономической деятельности 'Строительство жилых и нежилых зданий' в первом квартале года, предшествующего году, в котором кадастровая стоимость земельного участка установлена в размере его рыночной стоимости (%)")
    KSZU1: float = Field(..., description="Кадастровая стоимость земельного участка, установленная в размере его рыночной стоимости в рублях")
    KSZU2: float = Field(..., description="Кадастровая стоимость земельного участка, установленная в порядке, определенном статьей 14 или статьей 16 Федерального закона от 3 июля 2016 г. N 237-ФЗ 'О государственной кадастровой оценке', в рублях")

class LeaseRateResponse(BaseModel):
    lease_rate: float = Field(..., description="Ставка аренды")

@router.post("/calculate_lease_rate", response_model=LeaseRateResponse)
async def calculate_lease_rate_endpoint(request: LeaseRateRequest):
    try:
        k2_params = K2Params(**request.k2_params)
        k2 = calculate_k2(k2_params.PA1, k2_params.PA2, k2_params.KSZU1, k2_params.KSZU2)
        lease_rate = calculate_lease_rate(request.n, request.S, request.P, request.KSZU, request.k, request.k1, k2)
        return LeaseRateResponse(lease_rate=lease_rate)
    except Exception as e:
        raise HTTPException(status_code=400, detail=str(e))